name: Deploy Application

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.15.1'
          cache: 'npm'

      - name: Install dependencies (bypass postinstall)
        run: |
          # Environment variable use karke postinstall script disable karo
          npm ci --ignore-scripts
          npm install --save-dev @types/node
          echo "Dependencies installed without postinstall scripts"
        env:
          NPM_CONFIG_IGNORE_SCRIPTS: true

      - name: Build application (direct Next.js build)
        run: npx next build
        env:
          NODE_ENV: production
          NODE_OPTIONS: --max_old_space_size=4096
          SKIP_TYPE_CHECK: true

      - name: Prepare deployment files
        run: |
          # Clean up unnecessary files before deployment
          rm -rf .git .next/cache node_modules
          echo "Deployment files ready"

      - name: Fix remote permissions
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          script: |
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /var/www/html/newbase2brand/
            sudo chmod -R 755 /var/www/html/newbase2brand/

      - name: Deploy via Rsync 
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          REMOTE_HOST: ${{ secrets.SERVER_IP }}
          REMOTE_USER: ${{ secrets.SERVER_USER }}
          TARGET: /var/www/html/newbase2brand/
          ARGS: "-rlgoDzvc --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r --no-perms --no-owner --no-group --exclude=.next/cache --exclude=node_modules --exclude=.git --exclude=src"

      - name: Skip server dependencies (already built on GitHub Actions)
        run: |
          echo "Skipping server dependencies installation - already built on GitHub Actions"
          echo "Built files will be deployed directly"

      - name: Restart application
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          script: |
            cd /var/www/html/newbase2brand/
            pm2 reload newbase2brand || pm2 start "npm run start" --name newbase2brand
            pm2 save

      - name: Health check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_LIVE }}
          script: |
            pm2 status newbase2brand
            echo "ðŸŽ‰ Deployment completed"
